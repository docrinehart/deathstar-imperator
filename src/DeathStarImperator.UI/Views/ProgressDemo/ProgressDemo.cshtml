@{
    ViewBag.Title = "ProgressDemo";
}

<h2>A Job</h2>

<div style="text-align: center;" class="center-block">
    <button id="startButton" class="btn btn-default">Make Progress</button>
</div>

<div id="progressDisplay" style="display: none; margin-top: 15px;">
    <div id="progresssBar" class="progress">
        <div role="progressbar" aria-valuenow="60" id="progresssBarValue"
             class="progress-bar" aria-valuemin="0" style="width: 0%" aria-valuemax="100">
        </div>
    </div>
</div>

<div id="completedDisplay" style="display: none">
    <span class="glyphicon glyphicon-check"></span> Completed
</div>

@section scripts{
<!--Script references. -->
<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--SignalR script to update the chat page and send messages.-->
    <script>
        $("#startButton").click(function () {
            $('#startButton').prop('disabled', true);
            $('#startButton').css('display', 'none');
            $.ajax({
                url: '/progressdemo/dojob',
                method: 'POST',
                success: function (data) {
                    trackJobProgress(data);
                }
            });
        });

        function trackJobProgress(job) {
            setProgressBarWidth(job.Progress);
            $("#completedDisplay").hide();
            $('#progressDisplay').show();

            var progress = $.connection.progressHub;

            progress.client.progressChanged = function (jobId, progress) {
                setProgressBarWidth(progress);
            };

            progress.client.jobCompleted = function (jobId) {
                $('#progressDisplay').hide();
                $("#completedDisplay").show();
                $("#startButton").prop('disabled', false);
                $('#startButton').css('display', 'inline-block');
                $.connection.hub.stop();
            };

            $.connection.hub.start().done(function () {
                progress.server.trackJob(job.JobId);
            });
        }

        function setProgressBarWidth(progress) {
            $("#progresssBarValue").css("width", progress + "%");
        }
    </script>
}